<!DOCTYPE html>
<html lang="en">
<head>
    <!-- TODO APRICOT CHANGE THIS -->
    <title>Cute Project</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="chat-box"></div>
    <div id="input-panel">
        <input type="text" id="message-input" placeholder="Type your message here">
    </div>

    <script>
        //Used to replace anything that is not a letter or a number 
        let replaceWrongLettersRegex = /[^a-z0-9 ]/gi
        //Answers Memory
        let answers = {}
        //Last Question Memory
        let question = ""
        //Simplified Question Memory
        let filteredQuestion = ""
        //Is waiting for User to explain what the correct answer is
        let waitingForAnswer = false

        //When the page loads, it does the init function
        window.onload = init;

        function init()
        {
            //TODO APRICOT CHANGE THIS
            sendMessage("Hello! I'm the girl your son calls Mommy~", false)
            askWhatICanHelpYouWith()
        }

        function askWhatICanHelpYouWith()
        {
            sendMessage("What would you like to know?", false)
        }

        function handleKeyPress(event)
        {
            //If the pressed key was enter
            if (event.key == 'Enter')
            {  
                //Submits the text
                submitMessage();
            }
        }

        // Makes it that handleKeyPress happens when a key is pressed
        messageInput.addEventListener('keypress', handleKeyPress);

        // Submits the message in the text field
        function submitMessage()
        {
            //Finds out the text in the text field
            let inputText = document.getElementById('message-input').value
            //Clears the text field
            document.getElementById('message-input').value = '';

            //Removes any spaces at the start or end of the input
            inputText = inputText.trim()

            //If the text is empty
            if(inputText.length === 0)
            {
                //Do nothing
                return
            }

            //If Study Bot is awaiting an answer
            if(waitingForAnswer)
            {
                let answer = inputText
                waitingForAnswer = false
                //If the user wants to skip
                if(answer.toLowerCase() === "skip")
                {
                    //Ask again
                    askWhatICanHelpYouWith()
                    //Do nothing
                    return
                }
                //Set the answer to remember for later
                answers[filteredQuestion] = answer
                sendMessage(answer, true)
                sendMessage("Oh so the appropriate answer to the question \"" + question + "\" is \"" + answer + "\"!");
                sendMessage("Thank you! I will remember this.");
                askWhatICanHelpYouWith()
                //Do nothing more
                return
            }


            question = inputText
            //Remove all the commas and questions marks and so on, and turn the question to all lowercase in case the user asks in different case or forgets the question mark or so on...
            filteredQuestion = question.replaceAll(replaceWrongLettersRegex, "").toLowerCase()
            sendMessage(question, true)
            
            //Find answer
            let reply = answers[filteredQuestion]
            //If answer exists
            if(reply)
            {
                //Reply answer and ask again
                sendMessage(reply, false)
                sendMessage("I hope that helps!", false)
                askWhatICanHelpYouWith()
            }
            else //Answer doesn't exist
            {
                sendMessage("I'm sorry but I don't know the answer to this.", false)
                sendMessage("What is the appropriate reply to your question? (Type \"skip\" to skip)", false)
                //Start listening for answer
                waitingForAnswer = true
            }
        }

        // Send a message to the chat box
        function sendMessage(inputText, isUser)
        {
            //If user wants to quit
            if(inputText.toLowerCase() === "quit")
            {
                //Closes the tab
                window.close()
            }

            //Finds the chatbox
            let chatBox = document.getElementById('chat-box');
            //Creates a new html paragraph element
            let messageElement = document.createElement('p');

            //If text is sent by a User
            if(isUser)
            {
                messageElement.textContent = "You: " + inputText
                //Make it user color
                messageElement.classList.add("user-text")
            }
            else //Text is sent by StudyBot
            {
                messageElement.textContent = "StudyBot: " + inputText
                //Make it studybot color
                messageElement.classList.add("program-text")
            }
            //Add the new paragraph to the chatbox
            chatBox.appendChild(messageElement)

            let children = chatBox.children

            //If the chatbox has more than 20 lines
            if(children.length > 20)
            {
                //Remove the last chatbox line
                chatBox.removeChild(children[0])
            }
        }
    </script>
</body>
</html>